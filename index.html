<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Rankings Mobilizadores - Relatório 6500</title>
  <script src="./xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      background-color: #f4f6fb;
      font-family: Arial, sans-serif;
      margin: 20px;
      color: #333;
    }
    h1 {
      color: #0033a0;
      text-align: center;
    }
    p {
      text-align: center;
    }
    input[type="file"] {
      display: block;
      margin: 20px auto;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-top: 30px;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 20px;
    }
    .card h2 {
      color: #0033a0;
      margin-bottom: 5px;
    }
    .card h3 {
      color: #666;
      font-weight: normal;
      margin-top: 0;
    }
    .badge {
      display: inline-block;
      background: #ffcc00;
      color: #000;
      padding: 3px 10px;
      border-radius: 20px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      font-size: 13px;
      text-align: center;
    }
    th {
      background: #0033a0;
      color: #fff;
    }
    button {
      margin-top: 10px;
      background: #0033a0;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #00257a;
    }
  </style>
</head>
<body>
  <h1>Rankings dos Mobilizadores - Relatório 6500</h1>
  <p>Selecione o arquivo <strong>relatorio-6500.xlsx</strong> para gerar os rankings dos mobilizadores.</p>
  <input type="file" id="fileInput" accept=".xlsx,.xls" />
  <div class="grid" id="cardsContainer"></div>

  <script>
    const MOBILIZADORES = [
      { name: "Mobilizador Desembolso PF", cols: { nec: "I", rlz: "J", atg: "K" }, tipo: "Intradia" },
      { name: "Mobilizador Desembolso Giro", cols: { nec: "O", rlz: "P", atg: "Q" }, tipo: "Intradia" },
      { name: "Mobilizador Desembolso Agro", cols: { nec: "U", rlz: "V", atg: "W" }, tipo: "Intradia" },
      { name: "Mobilizador Icred 15/90", cols: { atg: "Z" }, tipo: "Icred" },
      { name: "Mobilizador Regulariza Dívidas Agro", cols: { nec: "AD", rlz: "AE", atg: "AF" }, tipo: "Intradia" },
      { name: "Mobilizador Portfólio Priorizado", cols: { nec: "AJ", rlz: "AK", atg: "AL" }, tipo: "Intradia" },
    ];

    document.getElementById('fileInput').addEventListener('change', handleFile, false);

    function handleFile(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const merged = sheet['!merges'] || [];
        const range = XLSX.utils.decode_range(sheet['!ref']);
        const grid = Array.from({ length: range.e.r + 1 }, () => Array(range.e.c + 1).fill(null));

        for (let r = range.s.r; r <= range.e.r; r++) {
          for (let c = range.s.c; c <= range.e.c; c++) {
            const cell = sheet[XLSX.utils.encode_cell({ r, c })];
            if (cell) grid[r][c] = cell.v;
          }
        }

        for (const m of merged) {
          const val = grid[m.s.r][m.s.c];
          for (let r = m.s.r; r <= m.e.r; r++) {
            for (let c = m.s.c; c <= m.e.c; c++) {
              grid[r][c] = val;
            }
          }
        }

        gerarRankings(grid);
      };
      reader.readAsArrayBuffer(file);
    }

    function gerarRankings(grid) {
      const container = document.getElementById('cardsContainer');
      container.innerHTML = "";

      MOBILIZADORES.forEach((mob, idx) => {
        const ranking = [];
        for (let i = 3; i < grid.length; i++) {
          const row = grid[i];
          const prefixo = row[0];
          if (!prefixo) continue;

          const agencia = row[1], carteira = row[3], tipo = row[4];

          let nec = rlz = atg = null;

          if (mob.tipo === "Intradia") {
            nec = parseNumber(row[colIndex(mob.cols.nec)]);
            rlz = parseNumber(row[colIndex(mob.cols.rlz)]);
            atg = parseNumber(row[colIndex(mob.cols.atg)]);

            if (isNaN(nec)) continue;
            if (isNaN(atg) && !isNaN(rlz) && nec !== 0) {
              atg = (rlz / nec) * 100;
            }
          } else if (mob.tipo === "Icred") {
            atg = parseNumber(row[colIndex(mob.cols.atg)]);
            if (isNaN(atg)) continue;
          }

          if (isNaN(atg)) continue;

          ranking.push({ prefixo, agencia, carteira, tipo, nec, rlz, atg });
        }

        ranking.sort((a, b) => b.atg - a.atg);
        renderCard(mob.name, mob.tipo, ranking, idx);
      });
    }

    function renderCard(title, tipo, data, id) {
      const container = document.getElementById('cardsContainer');
      const card = document.createElement('div');
      card.className = 'card';
      card.id = `card-${id}`;
      card.innerHTML = `
        <h2>${title}</h2>
        <h3>Critério: ${tipo}</h3>
        <div class="badge">${data.length} no ranking</div>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Prefixo</th>
              <th>Agência</th>
              <th>Carteira</th>
              <th>Tipo</th>
              <th>Nec. Dia</th>
              <th>Rlz Dia</th>
              <th>% Atg</th>
            </tr>
          </thead>
          <tbody>
            ${data.map((item, i) => `
              <tr>
                <td>${i + 1}</td>
                <td>${item.prefixo}</td>
                <td>${item.agencia}</td>
                <td>${item.carteira}</td>
                <td>${item.tipo}</td>
                <td>${item.nec ?? ''}</td>
                <td>${item.rlz ?? ''}</td>
                <td>${item.atg.toFixed(2)}%</td>
              </tr>`).join('')}
          </tbody>
        </table>
        <button onclick="baixarPNG(${id})">Baixar PNG</button>
      `;
      container.appendChild(card);
    }

    function baixarPNG(id) {
      const card = document.getElementById(`card-${id}`);
      html2canvas(card).then(canvas => {
        const link = document.createElement('a');
        link.download = `ranking-${id + 1}.png`;
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    function colIndex(col) {
      return XLSX.utils.decode_col(col);
    }

    function parseNumber(val) {
      if (typeof val === 'string') {
        val = val.replace('%', '').replace(',', '.');
      }
      const num = parseFloat(val);
      return isNaN(num) ? NaN : num;
    }
  </script>
</body>
</html>