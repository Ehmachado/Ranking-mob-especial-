<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema BB Mobilizadores - An√°lise Excel</title>
    <style>
        /* Cores do Banco do Brasil */
        :root {
            --bb-blue: #1e3a8a;
            --bb-light-blue: #3b82f6;
            --bb-yellow: #fbbf24;
            --bb-green: #10b981;
            --bb-red: #ef4444;
            --bb-gray: #f3f4f6;
            --bb-dark: #1f2937;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bb-blue) 0%, var(--bb-light-blue) 100%);
            min-height: 100vh;
            color: var(--bb-dark);
        }

        .header {
            background: var(--bb-blue);
            color: white;
            padding: 1.5rem 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 3px dashed transparent;
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: var(--bb-blue);
            background-color: #f8fafc;
        }

        .upload-zone {
            text-align: center;
            padding: 3rem 2rem;
        }

        .upload-icon {
            font-size: 4rem;
            color: var(--bb-blue);
            margin-bottom: 1rem;
        }

        .upload-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--bb-dark);
        }

        .upload-subtitle {
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        .btn-upload {
            background: var(--bb-blue);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-upload:hover {
            background: var(--bb-light-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        .file-input {
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--bb-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .mobilizer-group {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }

        .mobilizer-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--bb-blue);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--bb-blue);
        }

        .ranking-list {
            list-style: none;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 6px;
            border-left: 4px solid var(--bb-blue);
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .ranking-item.top-1 { border-left-color: #ffd700; }
        .ranking-item.top-2 { border-left-color: #c0c0c0; }
        .ranking-item.top-3 { border-left-color: #cd7f32; }

        .rank-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--bb-blue);
            margin-right: 1rem;
        }

        .mobilizer-name {
            flex: 1;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .percentage {
            font-size: 1.2rem;
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: var(--bb-gray);
        }

        .percentage.excellent { background: var(--bb-green); color: white; }
        .percentage.good { background: var(--bb-yellow); color: var(--bb-dark); }
        .percentage.poor { background: var(--bb-red); color: white; }

        .download-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--bb-gray);
            border-radius: 8px;
            text-align: center;
        }

        .btn-download {
            background: var(--bb-green);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-download:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .error-message {
            background: var(--bb-red);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--bb-blue);
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                margin: 1rem auto;
                padding: 0 0.5rem;
            }
            
            .upload-section {
                padding: 1.5rem;
            }
            
            .ranking-item {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè¶ Sistema BB Mobilizadores</h1>
        <p>An√°lise de Rankings por % de Atingimento</p>
    </div>

    <div class="container">
        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìä</div>
                <h2 class="upload-title">Enviar Arquivo Excel</h2>
                <p class="upload-subtitle">Arraste o arquivo aqui ou clique para selecionar</p>
                <button class="btn-upload" onclick="document.getElementById('fileInput').click()">
                    Selecionar Arquivo
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
                <p style="margin-top: 1rem; color: #6b7280; font-size: 0.9rem;">
                    Formatos aceitos: .xlsx, .xls (m√°x. 50MB)
                </p>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h3>Processando arquivo...</h3>
            <p>Analisando dados dos mobilizadores...</p>
        </div>

        <!-- Results -->
        <div class="results" id="results">
            <h2 style="text-align: center; margin-bottom: 2rem; color: var(--bb-blue);">
                üìà Rankings por Grupo de Mobilizador
            </h2>
            
            <div class="stats" id="stats"></div>
            <div id="rankingContent"></div>
            
            <div class="download-section">
                <h3 style="margin-bottom: 1rem; color: var(--bb-blue);">
                    üíæ Baixar Resultados
                </h3>
                <button class="btn-download" onclick="downloadResults()">
                    üìä Baixar Rankings (JSON)
                </button>
                <button class="btn-download" onclick="downloadImage()">
                    üñºÔ∏è Baixar Imagem (PNG)
                </button>
            </div>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage"></div>
    </div>

    <!-- SheetJS Library -->
    <script src="xlsx.full.min.js"></script>
    
    <script>
        // Dados das corre√ß√µes aplicadas
        const MOBILIZADOR_CONFIGS = {
            'Mobilizador Desembolso Agro': {
                'campos': [
                    { 'coluna': 'S', 'nome': 'Atg' },
                    { 'coluna': 'T', 'nome': 'Atg_T' },  // CORRIGIDO
                    { 'coluna': 'U', 'nome': 'Atg_U' }   // CORRIGIDO
                ]
            },
            'Mobilizador Regulariza D√≠vidas Agro': {
                'campos': [
                    { 'coluna': 'AB', 'nome': 'Conexao_105' },
                    { 'coluna': 'AC', 'nome': 'Conexao_AC' },  // CORRIGIDO
                    { 'coluna': 'AD', 'nome': 'Conexao_AD' },  // CORRIGIDO
                    { 'coluna': 'AE', 'nome': 'Conexao_AE' },  // CORRIGIDO
                    { 'coluna': 'AF', 'nome': 'Conexao_AF' },  // CORRIGIDO
                    { 'coluna': 'AG', 'nome': 'Conexao_AG' }   // CORRIGIDO
                ]
            }
        };

        let analyzedData = null;

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const uploadZone = document.getElementById('uploadZone');
            const uploadSection = document.getElementById('uploadSection');

            // File input change
            fileInput.addEventListener('change', handleFileSelect);

            // Drag and drop events
            uploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processFile(files[0]);
                }
            });
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function processFile(file) {
            // Validar arquivo
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showError('Por favor, selecione um arquivo Excel v√°lido (.xlsx ou .xls)');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                showError('Arquivo muito grande. Tamanho m√°ximo: 50MB');
                return;
            }

            showLoading();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Pegar a primeira planilha
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Converter para JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Analisar dados
                    analyzedData = analyzeMobilizerData(jsonData);
                    
                    // Mostrar resultados
                    displayResults(analyzedData);
                    
                } catch (error) {
                    console.error('Erro ao processar arquivo:', error);
                    showError('Erro ao processar arquivo Excel. Verifique se o formato est√° correto.');
                } finally {
                    hideLoading();
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function analyzeMobilizerData(data) {
            const results = {};
            let totalRecords = 0;
            
            // Encontrar cabe√ßalhos
            const headers = data[0] || [];
            
            // Processar cada grupo de mobilizador
            for (const [grupo, config] of Object.entries(MOBILIZADOR_CONFIGS)) {
                const grupoData = findMobilizerGroupData(data, grupo, headers);
                if (grupoData) {
                    results[grupo] = grupoData;
                    totalRecords += grupoData.mobilizadores.length;
                }
            }
            
            return {
                grupos: results,
                totalMobilizadores: totalRecords,
                timestamp: new Date().toLocaleString('pt-BR')
            };
        }

        function findMobilizerGroupData(data, grupoNome, headers) {
            let startRow = -1;
            
            // Encontrar linha do grupo
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (row && row.some(cell => 
                    typeof cell === 'string' && cell.includes(grupoNome)
                )) {
                    startRow = i + 1;
                    break;
                }
            }
            
            if (startRow === -1) return null;
            
            const config = MOBILIZADOR_CONFIGS[grupoNome];
            const mobilizadores = [];
            const columnIndexes = {};
            
            // Mapear colunas
            for (const campo of config.campos) {
                const colIndex = headers.findIndex(h => 
                    h && h.toString().toUpperCase().includes(campo.coluna.toUpperCase())
                );
                if (colIndex !== -1) {
                    columnIndexes[campo.nome] = colIndex;
                }
            }
            
            // Extrair dados dos mobilizadores
            for (let i = startRow; i < data.length; i++) {
                const row = data[i];
                
                // Parar se encontrar outro grupo
                if (row && row.some(cell => 
                    typeof cell === 'string' && 
                    cell.includes('Mobilizador') && 
                    !cell.includes(grupoNome)
                )) {
                    break;
                }
                
                // Skip linha vazia
                if (!row || row.length === 0 || !row[0]) continue;
                
                const nome = row[0];
                let percentualTotal = 0;
                let camposCount = 0;
                
                // Calcular percentual m√©dio dos campos dispon√≠veis
                for (const [campoNome, colIndex] of Object.entries(columnIndexes)) {
                    const valor = row[colIndex];
                    if (valor !== undefined && valor !== null && valor !== '') {
                        const percentual = parseFloat(valor.toString().replace('%', '').replace(',', '.'));
                        if (!isNaN(percentual)) {
                            percentualTotal += percentual;
                            camposCount++;
                        }
                    }
                }
                
                if (camposCount > 0) {
                    const percentualFinal = percentualTotal / camposCount;
                    mobilizadores.push({
                        nome: nome,
                        percentual: percentualFinal.toFixed(2),
                        camposUsados: camposCount
                    });
                }
            }
            
            // Ordenar por percentual
            mobilizadores.sort((a, b) => parseFloat(b.percentual) - parseFloat(a.percentual));
            
            return {
                mobilizadores: mobilizadores,
                total: mobilizadores.length,
                esperado: grupoNome.includes('Desembolso') ? 12 : 22
            };
        }

        function displayResults(data) {
            const statsContainer = document.getElementById('stats');
            const rankingContainer = document.getElementById('rankingContent');
            
            // Mostrar estat√≠sticas
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${data.totalMobilizadores}</div>
                    <div class="stat-label">Total de Mobilizadores</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Object.keys(data.grupos).length}</div>
                    <div class="stat-label">Grupos Analisados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.timestamp.split(' ')[0]}</div>
                    <div class="stat-label">Data da An√°lise</div>
                </div>
            `;
            
            // Mostrar rankings por grupo
            let html = '';
            Object.entries(data.grupos).forEach(([grupo, info], index) => {
                html += `
                    <div class="mobilizador-group">
                        <h3 class="mobilizer-title">${grupo}</h3>
                        <p style="margin-bottom: 1rem; color: #6b7280;">
                            Encontrados: <strong>${info.total}</strong> | Esperado: <strong>${info.esperado}</strong>
                        </p>
                        <ul class="ranking-list">
                `;
                
                info.mobilizadores.forEach((mobilizer, rankIndex) => {
                    const rankClass = rankIndex < 3 ? `top-${rankIndex + 1}` : '';
                    const percentage = parseFloat(mobilizer.percentual);
                    const percentageClass = percentage >= 100 ? 'excellent' : 
                                         percentage >= 80 ? 'good' : 'poor';
                    
                    html += `
                        <li class="ranking-item ${rankClass}">
                            <div class="rank-number">${rankIndex + 1}¬∫</div>
                            <div class="mobilizer-name">${mobilizer.nome}</div>
                            <div class="percentage ${percentageClass}">
                                ${mobilizer.percentual}%
                            </div>
                        </li>
                    `;
                });
                
                html += `
                        </ul>
                    </div>
                `;
            });
            
            rankingContainer.innerHTML = html;
            
            // Mostrar resultados
            document.getElementById('results').style.display = 'block';
            document.getElementById('uploadSection').style.display = 'none';
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            hideError();
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function downloadResults() {
            if (!analyzedData) return;
            
            const dataStr = JSON.stringify(analyzedData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `rankings_bb_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function downloadImage() {
            if (!analyzedData) return;
            
            // Criar canvas para a imagem
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Configurar canvas
            canvas.width = 1200;
            const estimatedHeight = Object.keys(analyzedData.grupos).length * 300 + 200;
            canvas.height = Math.max(estimatedHeight, 600);
            
            // Fundo
            ctx.fillStyle = '#f8fafc';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // T√≠tulo
            ctx.fillStyle = '#1e3a8a';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Rankings BB Mobilizadores', canvas.width/2, 60);
            
            // Data
            ctx.font = '18px Arial';
            ctx.fillText(analyzedData.timestamp, canvas.width/2, 90);
            
            let yPos = 150;
            
            // Rankings por grupo
            Object.entries(analyzedData.grupos).forEach(([grupo, info]) => {
                // T√≠tulo do grupo
                ctx.fillStyle = '#1e3a8a';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(grupo, 50, yPos);
                
                // Estat√≠sticas
                ctx.font = '16px Arial';
                ctx.fillStyle = '#6b7280';
                ctx.fillText(`Encontrados: ${info.total} | Esperado: ${info.esperado}`, 50, yPos + 25);
                
                yPos += 50;
                
                // Top 10 mobilizadores
                info.mobilizadores.slice(0, 10).forEach((mobilizer, index) => {
                    const rank = index + 1;
                    const percentage = parseFloat(mobilizer.percentual);
                    
                    // Ranking
                    ctx.font = 'bold 20px Arial';
                    ctx.fillStyle = '#1e3a8a';
                    ctx.fillText(`${rank}¬∫`, 50, yPos);
                    
                    // Nome
                    ctx.font = '18px Arial';
                    ctx.fillStyle = '#1f2937';
                    ctx.fillText(mobilizer.nome.substring(0, 50), 120, yPos);
                    
                    // Percentual
                    const percentageColor = percentage >= 100 ? '#10b981' : 
                                          percentage >= 80 ? '#fbbf24' : '#ef4444';
                    ctx.fillStyle = percentageColor;
                    ctx.font = 'bold 18px Arial';
                    ctx.textAlign = 'right';
                    ctx.fillText(`${mobilizer.percentual}%`, canvas.width - 50, yPos);
                    
                    yPos += 30;
                });
                
                yPos += 50;
            });
            
            // Baixar
            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `rankings_bb_${new Date().toISOString().split('T')[0]}.png`;
                link.click();
                URL.revokeObjectURL(url);
            });
        }

        // Verificar se xlsx.full.min.js est√° dispon√≠vel
        if (typeof XLSX === 'undefined') {
            showError('Biblioteca xlsx.full.min.js n√£o encontrada. Certifique-se de que o arquivo est√° na raiz do projeto.');
        }
    </script>
</body>
</html>