<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Ranking Mobilizadores - BB</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bb-blue: #0033a0;
      --bb-yellow: #ffcc00;
      --bb-light-bg: #f5f7fb;
      --bb-card-bg: #ffffff;
      --bb-border: #dde3f0;
      --bb-text: #1f2933;
      --bb-muted: #6b7280;
      --radius-xl: 22px;
      --shadow-soft: 0 10px 28px rgba(15, 23, 42, 0.14);
      --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px 24px 40px;
      font-family: var(--font);
      background: var(--bb-light-bg);
      color: var(--bb-text);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 18px;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      color: var(--bb-blue);
    }

    .subtitle {
      font-size: 13px;
      color: var(--bb-muted);
      margin-top: 4px;
      max-width: 620px;
    }

    .brand-pill {
      font-size: 10px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--bb-blue);
      color: var(--bb-blue);
      background: #eaf1ff;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .upload-area {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid var(--bb-border);
      box-shadow: 0 4px 10px rgba(148, 163, 253, 0.12);
      margin-bottom: 22px;
    }

    .upload-area label {
      font-size: 12px;
      color: var(--bb-text);
      font-weight: 500;
    }

    input[type="file"] {
      font-size: 11px;
      max-width: 260px;
    }

    .status {
      font-size: 11px;
      color: var(--bb-muted);
      margin-left: auto;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
      gap: 18px;
    }

    .card {
      position: relative;
      padding: 14px 16px 12px;
      border-radius: var(--radius-xl);
      background: var(--bb-card-bg);
      border: 1px solid var(--bb-border);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }

    .card-title-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--bb-blue);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .card-subtitle {
      font-size: 10px;
      color: var(--bb-muted);
    }

    .badges {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .badge {
      font-size: 9px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #f3f4ff;
      color: var(--bb-blue);
      border: 1px solid #d0dcff;
      font-weight: 500;
      white-space: nowrap;
    }

    .btn-png {
      font-size: 9px;
      padding: 4px 8px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: var(--bb-blue);
      color: #ffffff;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 4px 9px rgba(37, 99, 235, 0.25);
      white-space: nowrap;
    }

    .btn-png span.icon {
      font-size: 11px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 9px;
      margin-top: 4px;
      border-radius: 14px;
      overflow: hidden;
    }

    thead {
      background: linear-gradient(90deg, #f9fafb, #eef2ff);
    }

    th, td {
      padding: 4px 5px;
      text-align: left;
      border-bottom: 1px solid #eef2ff;
    }

    th {
      font-size: 8px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--bb-blue);
      font-weight: 600;
    }

    tbody tr:nth-child(odd) {
      background: #fafbff;
    }

    tbody tr:nth-child(even) {
      background: #ffffff;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .pos {
      width: 20px;
      font-weight: 700;
      color: var(--bb-blue);
    }

    .pct {
      font-weight: 700;
      text-align: right;
    }

    .pct.good {
      color: #16a34a;
    }

    .pct.medium {
      color: #f97316;
    }

    .pct.bad {
      color: #dc2626;
    }

    .num {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .small-note {
      font-size: 8px;
      color: var(--bb-muted);
      margin-top: 2px;
    }

    .empty {
      font-size: 9px;
      color: var(--bb-muted);
      padding-top: 2px;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div>
      <div class="brand-pill">Ranking Mobilizadores • Banco do Brasil</div>
      <h1>Painéis de Ranking por Mobilizador</h1>
      <div class="subtitle">
        Upload da planilha modelo 6500. Cada painel mostra apenas Prefixo / Agência / Carteira / Tipo de Carteira
        com <strong>Nec. Dia</strong> (ou %Atg no caso do Icred) para aquele Mobilizador, em layout pronto para exportar.
      </div>
    </div>
  </div>

  <div class="upload-area">
    <label for="file">Selecione o arquivo <strong>.xlsx</strong> do relatório:</label>
    <input type="file" id="file" accept=".xlsx" />
    <div class="status" id="status">Aguardando arquivo...</div>
  </div>

  <div class="grid" id="cards-container"></div>

  <script>
    const statusEl = document.getElementById("status");
    const cardsContainer = document.getElementById("cards-container");

    // Mapas fixos conforme especificado:
    const mobilizadoresConfig = [
      { key: "desembolso_pf", title: "Desembolso PF", start: "G", end: "K", mode: "intradia" },
      { key: "desembolso_giro", title: "Desembolso Giro", start: "M", end: "Q", mode: "intradia" },
      { key: "desembolso_agro", title: "Desembolso Agro", start: "S", end: "W", mode: "intradia" },
      { key: "icred_1590", title: "Icred 15/90", start: "Y", end: "Z", mode: "icred" },
      { key: "regulariza_agro", title: "Regulariza Dívidas Agro", start: "AB", end: "AF", mode: "intradia" },
      { key: "portfolio_priorizado", title: "Portfólio Priorizado", start: "AH", end: "AL", mode: "intradia" }
    ];

    document.getElementById("file").addEventListener("change", handleFile, false);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      statusEl.textContent = "Lendo planilha...";
      const reader = new FileReader();
      reader.onload = function (ev) {
        try {
          const data = new Uint8Array(ev.target.result);
          const wb = XLSX.read(data, { type: "array" });
          const sheetName = wb.SheetNames[0];
          const ws = wb.Sheets[sheetName];

          const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });
          buildRankings(rows);
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Erro ao ler planilha. Confirme o layout.";
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function buildRankings(rows) {
      cardsContainer.innerHTML = "";

      if (!rows || rows.length < 4) {
        statusEl.textContent = "Planilha com poucas linhas. Verifique o cabeçalho.";
        return;
      }

      const header2 = rows[2] || []; // linha com Nec. Dia / Rlz Dia / %Atg
      const prefixIdx = findColIndex(rows, ["Prefixo"]);
      const depIdx = findColIndex(rows, ["Dependência", "Dependencia"]);
      const cartIdx = findColIndex(rows, ["Carteira"]);
      const tipoIdx = findColIndex(rows, ["Tipo da Carteira", "Tipo Carteira"]);

      if ([prefixIdx, depIdx, cartIdx, tipoIdx].some(i => i === -1)) {
        statusEl.textContent = "Não encontrei Prefixo / Dependência / Carteira / Tipo de Carteira no cabeçalho.";
        return;
      }

      const configsResolved = mobilizadoresConfig.map(conf => {
        return {
          ...conf,
          startIdx: colToIndex(conf.start),
          endIdx: colToIndex(conf.end)
        };
      });

      const allCards = [];

      configsResolved.forEach(conf => {
        const indices = detectColumnsForMobilizador(header2, conf);
        const ranking = buildRankingForMobilizador(rows, conf, indices, {
          prefixIdx,
          depIdx,
          cartIdx,
          tipoIdx
        });
        const card = createRankingCard(conf, ranking, indices);
        if (card) {
          cardsContainer.appendChild(card);
          allCards.push(card);
        }
      });

      if (!allCards.length) {
        statusEl.textContent = "Nenhum dado elegível encontrado nos blocos de Mobilizadores.";
      } else {
        statusEl.textContent = "Rankings gerados. Clique em \"Baixar PNG\" em cada painel.";
      }
    }

    // Detecta colunas internas (Nec. Dia / Rlz Dia / %Atg) com base na terceira linha
    function detectColumnsForMobilizador(header2, conf) {
      const { startIdx, endIdx, mode } = conf;
      let necIdx = null, rlzIdx = null, pctIdx = null;

      for (let c = startIdx; c <= endIdx; c++) {
        const raw = (header2[c] || "").toString().trim();
        const norm = normalize(raw);

        if (mode === "icred") {
          // Procurar %Atg dentro de Y-Z
          if (!pctIdx && (norm.includes("%atg") || norm.includes("pctatg"))) {
            pctIdx = c;
          }
        } else {
          if (!necIdx && (norm.includes("necdia") || norm === "necdia")) necIdx = c;
          if (!rlzIdx && (norm.includes("rlzdia") || norm === "rlzdia")) rlzIdx = c;
          if (!pctIdx && (norm.includes("%atg") || norm.includes("%ating"))) pctIdx = c;
        }
      }

      return { necIdx, rlzIdx, pctIdx };
    }

    function buildRankingForMobilizador(rows, conf, idx, base) {
      const { mode } = conf;
      const { necIdx, rlzIdx, pctIdx } = idx;
      const { prefixIdx, depIdx, cartIdx, tipoIdx } = base;

      const ranking = [];

      for (let r = 3; r < rows.length; r++) {
        const row = rows[r] || [];
        const prefixo = row[prefixIdx];

        if (prefixo == null || prefixo === "") continue;

        const dependencia = row[depIdx];
        const carteira = row[cartIdx];
        const tipoCarteira = row[tipoIdx];

        let nec = necIdx != null ? toNumber(row[necIdx]) : null;
        let rlz = rlzIdx != null ? toNumber(row[rlzIdx]) : null;
        let pct = pctIdx != null ? toNumber(row[pctIdx]) : null;

        if (mode === "icred") {
          // Entra se tiver %Atg válido
          if (pct == null || isNaN(pct)) continue;
        } else {
          // Intradia: exige Nec. Dia > 0
          if (nec == null || isNaN(nec) || nec <= 0) continue;

          // Se %Atg não veio pronto mas há Nec + Rlz, calcula
          if ((pct == null || isNaN(pct)) && rlz != null && !isNaN(rlz) && nec !== 0) {
            pct = (rlz / nec) * 100;
          }

          if (pct == null || isNaN(pct)) continue;
        }

        ranking.push({
          prefixo,
          dependencia,
          carteira,
          tipoCarteira,
          necDia: nec,
          rlzDia: rlz,
          pct
        });
      }

      ranking.sort((a, b) => (b.pct || 0) - (a.pct || 0));
      return ranking;
    }

    function createRankingCard(conf, ranking, idx) {
      const card = document.createElement("div");
      card.className = "card";
      card.id = `card-${conf.key}`;

      const header = document.createElement("div");
      header.className = "card-header";

      const left = document.createElement("div");
      left.className = "card-title-wrap";

      const title = document.createElement("div");
      title.className = "card-title";
      title.textContent = `Mobilizador ${conf.title}`;
      left.appendChild(title);

      const subtitle = document.createElement("div");
      subtitle.className = "card-subtitle";
      subtitle.textContent =
        conf.mode === "icred"
          ? "Ranking por %Atg (somente linhas com indicador preenchido)."
          : "Ranking por %Atg Intradia (somente linhas com Nec. Dia > 0).";
      left.appendChild(subtitle);

      const right = document.createElement("div");
      right.className = "badges";

      const count = document.createElement("div");
      count.className = "badge";
      count.textContent = ranking.length
        ? `${ranking.length} linhas no ranking`
        : "Sem linhas elegíveis";
      right.appendChild(count);

      const range = document.createElement("div");
      range.className = "badge";
      range.textContent = `Colunas ${conf.start} a ${conf.end}`;
      right.appendChild(range);

      const btn = document.createElement("button");
      btn.className = "btn-png";
      btn.innerHTML = '<span class="icon">⬇</span><span>Baixar PNG</span>';
      btn.onclick = () =>
        downloadCardAsPNG(card, `ranking_${conf.key}.png`);
      right.appendChild(btn);

      header.appendChild(left);
      header.appendChild(right);
      card.appendChild(header);

      if (!ranking.length) {
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent =
          "Nenhum Prefixo/Carteira com Nec. Dia (ou %Atg no Icred) para este Mobilizador.";
        card.appendChild(empty);
        return card;
      }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const hr = document.createElement("tr");
      ["#", "Prefixo", "Agência", "Carteira", "Tipo", "Nec. Dia", "Rlz Dia", "% Atg"].forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        hr.appendChild(th);
      });
      thead.appendChild(hr);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      ranking.forEach((row, idxRow) => {
        const tr = document.createElement("tr");

        const tdPos = document.createElement("td");
        tdPos.className = "pos";
        tdPos.textContent = idxRow + 1;
        tr.appendChild(tdPos);

        const tdPref = document.createElement("td");
        tdPref.textContent = row.prefixo ?? "";
        tr.appendChild(tdPref);

        const tdDep = document.createElement("td");
        tdDep.textContent = row.dependencia ?? "";
        tr.appendChild(tdDep);

        const tdCart = document.createElement("td");
        tdCart.textContent = row.carteira ?? "";
        tr.appendChild(tdCart);

        const tdTipo = document.createElement("td");
        tdTipo.textContent = row.tipoCarteira ?? "";
        tr.appendChild(tdTipo);

        const tdNec = document.createElement("td");
        tdNec.className = "num";
        tdNec.textContent =
          row.necDia != null ? formatNumber(row.necDia) : "-";
        tr.appendChild(tdNec);

        const tdRlz = document.createElement("td");
        tdRlz.className = "num";
        tdRlz.textContent =
          row.rlzDia != null ? formatNumber(row.rlzDia) : "-";
        tr.appendChild(tdRlz);

        const tdPct = document.createElement("td");
        tdPct.className = "pct " + pctClass(row.pct);
        tdPct.textContent =
          row.pct != null ? row.pct.toFixed(2) + "%" : "-";
        tr.appendChild(tdPct);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      card.appendChild(table);

      const note = document.createElement("div");
      note.className = "small-note";
      note.textContent =
        conf.mode === "icred"
          ? "Critério: entradas com %Atg válido na faixa definida. Ordenado por %Atg (desc)."
          : "Critério: Nec. Dia > 0 na faixa do Mobilizador. %Atg da planilha ou calculado (Rlz/Nec). Ordenado por %Atg (desc).";
      card.appendChild(note);

      return card;
    }

    function colToIndex(col) {
      // Converte "A", "G", "AA", "AB" etc para índice 0-based
      let c = 0;
      for (let i = 0; i < col.length; i++) {
        c = c * 26 + (col.charCodeAt(i) - 64);
      }
      return c - 1;
    }

    function findColIndex(rows, labels) {
      const maxHeaderRows = 3;
      const targets = labels.map(l => normalize(l));
      for (let r = 0; r < Math.min(maxHeaderRows, rows.length); r++) {
        const row = rows[r] || [];
        for (let c = 0; c < row.length; c++) {
          const val = normalize(row[c] || "");
          if (targets.includes(val)) return c;
        }
      }
      return -1;
    }

    function normalize(str) {
      return str
        .toString()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9%]/g, "");
    }

    function toNumber(v) {
      if (v == null || v === "") return null;
      const n = parseFloat(
        v.toString().replace("%", "").replace(".", "").replace(",", ".")
      );
      return isNaN(n) ? null : n;
    }

    function formatNumber(n) {
      const num = Number(n);
      if (isNaN(num)) return "";
      return num.toLocaleString("pt-BR", {
        maximumFractionDigits: 2
      });
    }

    function pctClass(pct) {
      if (pct == null) return "";
      if (pct >= 105) return "good";
      if (pct >= 90) return "medium";
      return "bad";
    }

    async function downloadCardAsPNG(cardEl, filename) {
      const clone = cardEl.cloneNode(true);
      clone.style.position = "fixed";
      clone.style.left = "0";
      clone.style.top = "0";
      clone.style.width = "1280px";
      clone.style.maxWidth = "1280px";
      clone.style.transform = "none";
      clone.style.margin = "0";
      clone.style.zIndex = "-1";
      clone.style.boxShadow = "none";
      clone.style.borderRadius = "24px";
      clone.style.background = "#ffffff";
      document.body.appendChild(clone);

      try {
        const canvas = await html2canvas(clone, {
          scale: 3,
          backgroundColor: "#ffffff",
          useCORS: true
        });
        const link = document.createElement("a");
        link.download = filename;
        link.href = canvas.toDataURL("image/png");
        link.click();
      } catch (e) {
        console.error(e);
        alert("Erro ao gerar PNG deste painel.");
      } finally {
        document.body.removeChild(clone);
      }
    }
  </script>
</body>
</html>